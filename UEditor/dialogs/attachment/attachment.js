(function(){var uploadFile,onlineFile;function initTabs(){for(var e=$G("tabhead").children,t=0;t<e.length;t++)domUtils.on(e[t],"click",(function(e){setTabFocus((e.target||e.srcElement).getAttribute("data-content-id"))}));setTabFocus("upload")}function setTabFocus(e){if(e){var t,i,a=$G("tabhead").children;for(t=0;t<a.length;t++)(i=a[t].getAttribute("data-content-id"))==e?(domUtils.addClass(a[t],"focus"),domUtils.addClass($G(i),"focus")):(domUtils.removeClasses(a[t],"focus"),domUtils.removeClasses($G(i),"focus"));switch(e){case"upload":uploadFile=uploadFile||new UploadFile("queueList");break;case"online":onlineFile=onlineFile||new OnlineFile("fileList")}}}function initButtons(){dialog.onok=function(){for(var e,t=[],i=$G("tabhead").children,a=0;a<i.length;a++)if(domUtils.hasClass(i[a],"focus")){e=i[a].getAttribute("data-content-id");break}switch(e){case"upload":t=uploadFile.getInsertList();var s=uploadFile.getQueueCount();if(s)return $(".info","#queueList").html('<span style="color:red;">'+"还有2个未上传文件".replace(/[\d]/,s)+"</span>"),!1;break;case"online":t=onlineFile.getInsertList()}editor.execCommand("insertfile",t)}}function UploadFile(e){this.$wrap=e.constructor==String?$("#"+e):$(e),this.init()}function OnlineFile(e){this.container=utils.isString(e)?document.getElementById(e):e,this.init()}window.onload=function(){initTabs(),initButtons()},UploadFile.prototype={init:function(){this.fileList=[],this.initContainer(),this.initUploader()},initContainer:function(){this.$queue=this.$wrap.find(".filelist")},initUploader:function(){var e,t,i,a=this,s=jQuery,n=a.$wrap,o=n.find(".filelist"),l=n.find(".statusBar"),r=l.find(".info"),d=n.find(".uploadBtn"),u=(n.find(".filePickerBtn"),n.find(".filePickerBlock")),p=n.find(".placeholder"),c=l.find(".progress").hide(),f=0,h=0,g=window.devicePixelRatio||1,m=113*g,v=113*g,b="",C={},x=(i="transition"in(t=document.createElement("p").style)||"WebkitTransition"in t||"MozTransition"in t||"msTransition"in t||"OTransition"in t,t=null,i),w=editor.getActionUrl(editor.getOpt("fileActionName")),F=editor.getOpt("fileMaxSize"),U=(editor.getOpt("fileAllowFiles")||[]).join("").replace(/\./g,",").replace(/^[,]/,"");function S(t){var i=s('<li id="'+t.id+'"><p class="title">'+t.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),a=s('<div class="file-panel"><span class="cancel">'+lang.uploadDelete+'</span><span class="rotateRight">'+lang.uploadTurnRight+'</span><span class="rotateLeft">'+lang.uploadTurnLeft+"</span></div>").appendTo(i),n=i.find("p.progress span"),o=i.find("p.imgWrap"),l=s('<p class="error"></p>').hide().appendTo(i),r=function(e){switch(e){case"exceed_size":text=lang.errorExceedSize;break;case"interrupt":text=lang.errorInterrupt;break;case"http":text=lang.errorHttp;break;case"not_allow_type":text=lang.errorFileType;break;default:text=lang.errorUploadRetry}l.text(text).show()};"invalid"===t.getStatus()?r(t.statusText):(o.text(lang.uploadPreview),-1=="|png|jpg|jpeg|bmp|gif|".indexOf("|"+t.ext.toLowerCase()+"|")?o.empty().addClass("notimage").append('<i class="file-preview file-type-'+t.ext.toLowerCase()+'"></i><span class="file-title" title="'+t.name+'">'+t.name+"</span>"):browser.ie&&browser.version<=7?o.text(lang.uploadNoPreview):e.makeThumb(t,(function(e,t){if(e||!t)o.text(lang.uploadNoPreview);else{var i=s('<img src="'+t+'">');o.empty().append(i),i.on("error",(function(){o.text(lang.uploadNoPreview)}))}}),m,v),C[t.id]=[t.size,0],t.rotation=0,t.ext&&-1!=U.indexOf(t.ext.toLowerCase())||(r("not_allow_type"),e.removeFile(t))),t.on("statuschange",(function(e,s){"progress"===s?n.hide().width(0):"queued"===s&&(i.off("mouseenter mouseleave"),a.remove()),"error"===e||"invalid"===e?(r(t.statusText),C[t.id][1]=1):"interrupt"===e?r("interrupt"):"queued"===e?C[t.id][1]=0:"progress"===e&&(l.hide(),n.css("display","block")),i.removeClass("state-"+s).addClass("state-"+e)})),i.on("mouseenter",(function(){a.stop().animate({height:30})})),i.on("mouseleave",(function(){a.stop().animate({height:0})})),a.on("click","span",(function(){var i;switch(s(this).index()){case 0:return void e.removeFile(t);case 1:t.rotation+=90;break;case 2:t.rotation-=90}x?(i="rotate("+t.rotation+"deg)",o.css({"-webkit-transform":i,"-mos-transform":i,"-o-transform":i,transform:i})):o.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+~~(t.rotation/90%4+4)%4+")")})),i.insertBefore(u)}function y(){var e,t=0,i=0,a=c.children();s.each(C,(function(e,a){i+=a[0],t+=a[0]*a[1]})),e=i?t/i:0,a.eq(0).text(Math.round(100*e)+"%"),a.eq(1).css("width",Math.round(100*e)+"%"),_()}function k(t,i){if(t!=b){var s=e.getStats();switch(d.removeClass("state-"+b),d.addClass("state-"+t),t){case"pedding":o.addClass("element-invisible"),l.addClass("element-invisible"),p.removeClass("element-invisible"),c.hide(),r.hide(),e.refresh();break;case"ready":p.addClass("element-invisible"),o.removeClass("element-invisible"),l.removeClass("element-invisible"),c.hide(),r.show(),d.text(lang.uploadStart),e.refresh();break;case"uploading":c.show(),r.hide(),d.text(lang.uploadPause);break;case"paused":c.show(),r.hide(),d.text(lang.uploadContinue);break;case"confirm":if(c.show(),r.hide(),d.text(lang.uploadStart),(s=e.getStats()).successNum&&!s.uploadFailNum)return void k("finish");break;case"finish":c.hide(),r.show(),s.uploadFailNum?d.text(lang.uploadRetry):d.text(lang.uploadStart)}b=t,_()}a.getQueueCount()?d.removeClass("disabled"):d.addClass("disabled")}function _(){var t,i="";"ready"===b?i=lang.updateStatusReady.replace("_",f).replace("_KB",WebUploader.formatSize(h)):"confirm"===b?(t=e.getStats()).uploadFailNum&&(i=lang.updateStatusConfirm.replace("_",t.successNum).replace("_",t.successNum)):(t=e.getStats(),i=lang.updateStatusFinish.replace("_",f).replace("_KB",WebUploader.formatSize(h)).replace("_",t.successNum),t.uploadFailNum&&(i+=lang.updateStatusError.replace("_",t.uploadFailNum))),r.html(i)}WebUploader.Uploader.support()?editor.getOpt("fileActionName")?((e=a.uploader=WebUploader.create({pick:{id:"#filePickerReady",label:lang.uploadSelectFile},swf:"../../third-party/webuploader/Uploader.swf",server:w,fileVal:editor.getOpt("fileFieldName"),duplicate:!0,fileSingleSizeLimit:F,compress:!1})).addButton({id:"#filePickerBlock"}),e.addButton({id:"#filePickerBtn",label:lang.uploadAddFile}),k("pedding"),e.on("fileQueued",(function(e){f++,h+=e.size,1===f&&(p.addClass("element-invisible"),l.show()),S(e)})),e.on("fileDequeued",(function(e){f--,h-=e.size,function(e){var t=s("#"+e.id);delete C[e.id],y(),t.off().find(".file-panel").off().end().remove()}(e),y()})),e.on("filesQueued",(function(t){e.isInProgress()||"pedding"!=b&&"finish"!=b&&"confirm"!=b&&"ready"!=b||k("ready"),y()})),e.on("all",(function(t,i){switch(t){case"uploadFinished":k("confirm");break;case"startUpload":var a=utils.serializeParam(editor.queryCommandValue("serverparam"))||"",s=utils.formatUrl(w+(-1==w.indexOf("?")?"?":"&")+"encode=utf-8&"+a);e.option("server",s),k("uploading");break;case"stopUpload":k("paused")}})),e.on("uploadBeforeSend",(function(e,t,i){if(i.X_Requested_With="XMLHttpRequest",editor.options.headers&&"[object Object]"===Object.prototype.toString.apply(editor.options.headers))for(var a in editor.options.headers)i[a]=editor.options.headers[a]})),e.on("uploadProgress",(function(e,t){s("#"+e.id).find(".progress span").css("width",100*t+"%"),C[e.id][1]=t,y()})),e.on("uploadSuccess",(function(e,t){var i=s("#"+e.id);try{var n=t._raw||t,o=utils.str2json(n);"SUCCESS"==o.state?(a.fileList.push(o),i.append('<span class="success"></span>')):i.find(".error").text(o.state).show()}catch(e){i.find(".error").text(lang.errorServerUpload).show()}})),e.on("uploadError",(function(e,t){})),e.on("error",(function(e,t){"Q_TYPE_DENIED"!=e&&"F_EXCEED_SIZE"!=e||S(t)})),e.on("uploadComplete",(function(e,t){})),d.on("click",(function(){if(s(this).hasClass("disabled"))return!1;"ready"===b||"paused"===b?e.upload():"uploading"===b&&e.stop()})),d.addClass("state-"+b),y()):s("#filePickerReady").after(s("<div>").html(lang.errorLoadConfig)).hide():s("#filePickerReady").after(s("<div>").html(lang.errorNotSupport)).hide()},getQueueCount:function(){var e,t,i,a=0,s=this.uploader.getFiles();for(t=0;e=s[t++];)"queued"!=(i=e.getStatus())&&"uploading"!=i&&"progress"!=i||a++;return a},getInsertList:function(){var e,t,i,a=[],s=editor.getOpt("fileUrlPrefix");for(e=0;e<this.fileList.length;e++)t=(i=this.fileList[e]).url,a.push({title:i.original||t.substr(t.lastIndexOf("/")+1),url:s+t});return a}},OnlineFile.prototype={init:function(){this.initContainer(),this.initEvents(),this.initData()},initContainer:function(){this.container.innerHTML="",this.list=document.createElement("ul"),this.clearFloat=document.createElement("li"),domUtils.addClass(this.list,"list"),domUtils.addClass(this.clearFloat,"clearFloat"),this.list.appendChild(this.clearFloat),this.container.appendChild(this.list)},initEvents:function(){var e=this;domUtils.on($G("fileList"),"scroll",(function(t){var i=this;i.scrollHeight-(i.offsetHeight+i.scrollTop)<10&&e.getFileData()})),domUtils.on(this.list,"click",(function(e){var t=(e.target||e.srcElement).parentNode;"li"==t.tagName.toLowerCase()&&(domUtils.hasClass(t,"selected")?domUtils.removeClasses(t,"selected"):domUtils.addClass(t,"selected"))}))},initData:function(){this.state=0,this.listSize=editor.getOpt("fileManagerListSize"),this.listIndex=0,this.listEnd=!1,this.getFileData()},getFileData:function(){var _this=this;_this.listEnd||this.isLoadingData||(this.isLoadingData=!0,ajax.request(editor.getActionUrl(editor.getOpt("fileManagerActionName")),{timeout:1e5,data:utils.extend({start:this.listIndex,size:this.listSize},editor.queryCommandValue("serverparam")),method:"get",onsuccess:function(r){try{var json=eval("("+r.responseText+")");"SUCCESS"==json.state&&(_this.pushData(json.list),_this.listIndex=parseInt(json.start)+parseInt(json.list.length),_this.listIndex>=json.total&&(_this.listEnd=!0),_this.isLoadingData=!1)}catch(e){if(-1!=r.responseText.indexOf("ue_separate_ue")){var list=r.responseText.split(r.responseText);_this.pushData(list),_this.listIndex=parseInt(list.length),_this.listEnd=!0,_this.isLoadingData=!1}}},onerror:function(){_this.isLoadingData=!1}}))},pushData:function(e){var t,i,a,s,n,o=this,l=editor.getOpt("fileManagerUrlPrefix");for(t=0;t<e.length;t++)if(e[t]&&e[t].url){if(i=document.createElement("li"),n=document.createElement("span"),a=e[t].url.substr(e[t].url.lastIndexOf(".")+1),-1!="png|jpg|jpeg|gif|bmp".indexOf(a))s=document.createElement("img"),domUtils.on(s,"load",function(e){return function(){o.scale(e,e.parentNode.offsetWidth,e.parentNode.offsetHeight)}}(s)),s.width=113,s.setAttribute("src",l+e[t].url+(-1==e[t].url.indexOf("?")?"?noCache=":"&noCache=")+(+new Date).toString(36));else{var r=document.createElement("i"),d=document.createElement("span");d.innerHTML=e[t].url.substr(e[t].url.lastIndexOf("/")+1),(s=document.createElement("div")).appendChild(r),s.appendChild(d),domUtils.addClass(s,"file-wrapper"),domUtils.addClass(d,"file-title"),domUtils.addClass(r,"file-type-"+a),domUtils.addClass(r,"file-preview")}domUtils.addClass(n,"icon"),i.setAttribute("data-url",l+e[t].url),e[t].original&&i.setAttribute("data-title",e[t].original),i.appendChild(s),i.appendChild(n),this.list.insertBefore(i,this.clearFloat)}},scale:function(e,t,i,a){var s=e.width,n=e.height;"justify"==a?s>=n?(e.width=t,e.height=i*n/s,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t*s/n,e.height=i,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px"):s>=n?(e.width=t*s/n,e.height=i,e.style.marginLeft="-"+parseInt((e.width-t)/2)+"px"):(e.width=t,e.height=i*n/s,e.style.marginTop="-"+parseInt((e.height-i)/2)+"px")},getInsertList:function(){var e,t=this.list.children,i=[];for(e=0;e<t.length;e++)if(domUtils.hasClass(t[e],"selected")){var a=t[e].getAttribute("data-url"),s=t[e].getAttribute("data-title")||a.substr(a.lastIndexOf("/")+1);i.push({title:s,url:a})}return i}}})();